#!/bin/zsh
setopt nullglob

# Usage: mp4len [directory]
DIR="${1:-.}"

total=0
tempdir=$(mktemp -d)

# Process files in parallel
for f in "$DIR"/*.{mp4,mkv,mov,webm}; do
 [[ -f "$f" ]] || continue
  {
    dur=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$f" 2>/dev/null)
    [[ -n "$dur" ]] && echo "${dur%.*}" > "$tempdir/$(basename "$f")"
  } &
done

wait

# Sum up results and display individual files
echo "File                                     Duration"
echo "---------------------------------------- --------"
for durfile in "$tempdir"/*; do
  if [[ -f "$durfile" ]]; then
    dur=$(cat "$durfile")
    filename=$(basename "$durfile")
    
    # Calculate visual width (approximation for common Unicode chars)
    visual_width=0
    for (( i=0; i<${#filename}; i++ )); do
      char="${filename:$i:1}"
      if [[ "$char" =~ [一-龯：｜] ]]; then
        # CJK and fullwidth chars count as 2
        ((visual_width += 2))
      else
        ((visual_width += 1))
      fi
    done
    
    # Truncate based on visual width
    if [[ $visual_width -gt 40 ]]; then
      truncated=""
      current_width=0
      for (( i=0; i<${#filename}; i++ )); do
        char="${filename:$i:1}"
        if [[ "$char" =~ [一-龯：｜] ]]; then
          char_width=2
        else
          char_width=1
        fi
        if [[ $((current_width + char_width)) -le 37 ]]; then
          truncated+="$char"
          ((current_width += char_width))
        else
          break
        fi
      done
      display_name="${truncated}..."
      display_width=$((current_width + 3))
    else
      display_name="$filename"
      display_width=$visual_width
    fi
    
    # Calculate padding needed
    padding=$((40 - display_width))
    printf "%s%*s %8s\n" "$display_name" $padding "" "$(printf "%02d:%02d:%02d" $((dur/3600)) $(((dur%3600)/60)) $((dur%60)))"
    (( total += dur ))
  fi
done
echo "---------------------------------------- --------"

rm -rf "$tempdir"

printf "%40s %8s\n" "Total:" "$(printf "%02d:%02d:%02d" $((total/3600)) $(((total%3600)/60)) $((total%60)))"